# -------------------------------------------------------------------------------------------
# qblocks - fast, easily-accessible, fully-decentralized data from blockchains
# copyright (c) 2016, 2021 TrueBlocks, LLC (http://trueblocks.io)
# -------------------------------------------------------------------------------------------

#
# This is the system-wide docker compose file. Generally speaking, you will not edit this file.
# Instead, you may customize how this image works by copying the `docker-compose.local.example`
# file to `docker-compose.local.yml`, customizing things there, and standing up the container with:
#
#    docker compose -f docker-compose.yml -f docker-compose.local.yml up
#
# In this file, we create two services: core and monitors.
#

name: TrueBlocksCore

services:
  core:
    # The location (on docker-hub) of the core image we're using.
    image: trueblocks/core:0.40.2-beta

    # The location on the local disc of the core image's Dockerfile.
    build: ./build/core

    # An instruction to expose the container's internal :8080 port externally to the host machine.
    # Note, if you get an error message such as "Ports are not available...bind: address already in use",
    # or similar, restate this setting in the `docker-compose.local.yml` file and change the first
    # of these two ports (i.e. the port on the host machine). It's best not to change the setting here.
    ports:
      - "8080:8080"

    # An instruction telling docker where to find customizations to how chifra is to be run. See the
    # README.md file more information.
    env_file: .env

    # Defines internal docker folders where chifra's cache and the Unchained Index are stored.Note that
    # this must be consistent with the same definition below. Expose these folders on the host machine
    # by customizing the `docker-compose.local.yml` file.
    volumes:
      # The folder (internal to docker) where chifra stores the Unchained Index.
      - Index:/index
      # The folder (internal to docker) where chifra stores its cached data.
      - Cache:/cache

  monitors:
    # Tells docker that this service cannot run without the core image also running
    depends_on:
      - core

    # Instructs docker to restart the monitor if it falls down for some reason
    restart: unless-stopped

    # The location (on docker-hub) of the monitors image we're using
    image: trueblocks/monitors:0.40.2-beta

    # The location on the local disc of the core image's Dockerfile
    build: ./build/monitors

    # The same environment file as above providing the same configuration for TrueBlocks.
    env_file: .env

    # A list of volumes (corresponding to the above) with two additional volumes used by the monitors service.
    volumes:
      # The folder (internal to docker) where chifra stores the Unchained Index (same as above).
      - Index:/index
      # The folder (internal to docker) where chifra stores its cached data (same as above).
      - Cache:/cache
      # The folder (internal to docker) where `chifra monitors --watch` exports its results. See the comments
      # in docker-compose.local.example for information on exposing this folder externally to the host machine.
      - exports:/exports
      # The folder (internal to docker) where `chifra monitors --watch` looks for its list of addresses
      # to monitor. See the comments in docker-compose.local.example for information on exposing this
      # folder externally to the host machine.
      - addresses:/addresses

# An instruction telling docker to persist these volumes when the container is brought down. Otherwise,
# they will be removed.
volumes:
  Index:
  Cache:
  exports:
  addresses:
